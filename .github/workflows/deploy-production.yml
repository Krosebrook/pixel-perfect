name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "production-deployment"
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Application to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Track Deployment Start
        run: |
          curl -X POST "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/track-deployment" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "action": "track_deployment",
              "data": {
                "deployment_type": "production",
                "commit_sha": "${{ github.sha }}",
                "workflow_run_id": "${{ github.run_id }}",
                "started_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
                "status": "pending"
              }
            }' || echo "Failed to track deployment start"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Application
        id: build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Track Deployment Success
        if: success()
        run: |
          STARTED_AT=$(date -u -d "2 minutes ago" +"%Y-%m-%dT%H:%M:%SZ")
          COMPLETED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X POST "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/track-deployment" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "action": "update_deployment",
              "data": {
                "id": "${{ github.run_id }}",
                "status": "success",
                "completed_at": "'"${COMPLETED_AT}"'",
                "deployment_url": "${{ steps.deployment.outputs.page_url }}"
              }
            }' || echo "Failed to track deployment success"
      
      - name: Get Previous Deployment SHA
        if: success()
        id: prev_sha
        run: |
          PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          echo "sha=$PREV_SHA" >> $GITHUB_OUTPUT
      
      - name: Get Commits for Changelog
        if: success()
        id: commits
        run: |
          if [ -n "${{ steps.prev_sha.outputs.sha }}" ]; then
            COMMITS=$(git log --pretty=format:'{"sha":"%H","message":"%s","author":"%an","date":"%ai"}' ${{ steps.prev_sha.outputs.sha }}..${{ github.sha }} | jq -s '.')
          else
            COMMITS=$(git log --pretty=format:'{"sha":"%H","message":"%s","author":"%an","date":"%ai"}' -10 | jq -s '.')
          fi
          echo "json<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Generate Changelog
        if: success()
        run: |
          curl -X POST "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/generate-changelog" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "deployment_id": "${{ github.run_id }}",
              "current_sha": "${{ github.sha }}",
              "previous_sha": "${{ steps.prev_sha.outputs.sha }}",
              "commits": ${{ steps.commits.outputs.json }},
              "repo_owner": "${{ github.repository_owner }}",
              "repo_name": "${{ github.event.repository.name }}"
            }' || echo "Failed to generate changelog"
      
      - name: Track Deployment Failure
        if: failure()
        run: |
          COMPLETED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X POST "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/track-deployment" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "action": "update_deployment",
              "data": {
                "id": "${{ github.run_id }}",
                "status": "failed",
                "completed_at": "'"${COMPLETED_AT}"'",
                "error_message": "Build or deployment failed"
              }
            }' || echo "Failed to track deployment failure"
      
      - name: Deployment Summary
        run: |
          echo "### ✅ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
  
  deploy-failure-notification:
    name: Handle CI Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: CI Failure Notice
        run: |
          echo "### ❌ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production deployment was skipped because CI tests failed." >> $GITHUB_STEP_SUMMARY
          echo "Please fix the failing tests before deploying to production." >> $GITHUB_STEP_SUMMARY
